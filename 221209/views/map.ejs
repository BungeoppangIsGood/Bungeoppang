<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>붕어빵</title>
    <script src="https://cdn.jsdelivr.net/npm/ol@v7.1.0/dist/ol.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3"
      crossorigin="anonymous"
    ></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/ol@v7.1.0/ol.css"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
    />
    <link rel="icon" href="../img/mapIcon.png" />
  </head>
  <body>
    <style>
      * {
        font-family: "Noto Sans KR", sans-serif;
        padding: 0;
        margin: 0;
      }

      #searchBox {
        width: 90%;
        position: absolute;
        display: flex;
        align-items: center;
        margin-top: 10px;
        margin-left: 50px;
        z-index: 1;
      }

      .logo {
        width: 30px;
      }
      .buttonBox {
        position: absolute;
        bottom: 30px;
        left: 16px;
        z-index: 1;
      }
      .btn {
        font-size: 12px;
      }
    </style>

    <!-- 검색창 -->

    <form id="searchBox">
      <input
        class="form-control w-50"
        name="keyword"
        placeholder="장소 검색"
        aria-label="위치 검색"
      />
      <button
        type="submit"
        class="btn btn-primary text-nowrap"
        data-bs-toggle="modal"
        data-bs-target="#exampleModal"
      >
        검색
      </button>
    </form>

    <!-- 검색모달 -->

    <div
      class="modal fade"
      id="exampleModal"
      tabindex="-1"
      aria-labelledby="exampleModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="exampleModalLabel">
              <img class="logo" src="../img/mapIcon.png" /> 검색 결과
              <img class="logo" src="../img/mapIcon.png" />
            </h1>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body p-0">
            <div class="resultBox"></div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              닫기
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- 지도 -->

    <div class="wrap">
      <div id="map" style="height: 100vh"></div>
    </div>

    <!-- 버튼 -->

    <div class="buttonBox">
      <div class="btn-group" role="group" aria-label="Third group">
        <button
          type="button"
          class="btn btn-light shadow-sm"
          onclick="clickCurrentLocation()"
        >
          <span class="material-symbols-outlined">my_location</span>
        </button>
      </div>
      <div class="btn-group" role="group" aria-label="Third group">
        <button
          type="button"
          class="btn btn-light shadow-sm"
          onclick="myPage()"
        >
          <span class="material-symbols-outlined"> contact_page </span>
        </button>
      </div>
      <div class="btn-group" role="group" aria-label="Third group">
        <button
          type="button"
          class="btn btn-light shadow-sm"
          onclick="registration()"
        >
          <span class="material-symbols-outlined"> where_to_vote </span>
        </button>
      </div>
    </div>
  </body>

  <script>
    const DST = "EPSG:900913";
    const SRC = "EPSG:4326";
    const xyz = new ol.source.XYZ({
      url: "http://mt0.google.com/vt/lyrs=m&h1=ko&x={x}&y={y}&z={z}",
      crossOrigin: "anonymous",
    });

    const view = new ol.View({
      projection: DST,
      zoom: 11,
      center: ol.proj.transform([127.0802159, 37.5383777], SRC, DST),
      constrainResolution: true,
    });

    const tileLayer = new ol.layer.Tile({ source: xyz });
    const map = new ol.Map({ target: "map", layers: [tileLayer], view });

    let places;

    const searchBox = document.getElementById("searchBox");
    searchBox.addEventListener("submit", search);
    async function search() {
      event.preventDefault();
      const response = await axios({
        method: "GET",
        url: "http://knsan189.iptime.org:8080/api/map/search",
        params: {
          keyword: searchBox.keyword.value,
        },
      });

      const resultBox = document.querySelector(".resultBox");
      places = response.data;

      resultBox.innerHTML = "";
      for (let i = 0; i < places.length; i++) {
        resultBox.innerHTML += `<div onclick="clickMove(${i})" data-bs-dismiss="modal" aria-label="Close" class="px-3 py-2"><p class="fs-5 m-0" >${places[i].title}</p><p class="m-0 fs-6">${places[i].address.road}</p></div><hr>`;
      }
    }

    function clickMove(i) {
      const center = ol.proj.fromLonLat([places[i].point.x, places[i].point.y]);
      view.animate({
        center,
        duration: 2000,
        zoom: 16,
      });
    }

    function clickCurrentLocation() {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const lat = position.coords.latitude;
          const lon = position.coords.longitude;
          const center = ol.proj.fromLonLat([lon, lat]);
          view.animate({
            center,
            duration: 2000,
            zoom: 16,
          });
        },
        (error) => {
          alert("위치 정보를 찾을 수 없습니다.");
        },
        {
          enableHighAccuracy: true,
          maximumAge: 0,
          timeout: 5000,
        }
      );
    }

    function registration() {
      console.log("가게등록");
    }

    function myPage() {
      console.log("마이페이지");
    }
  </script>
</html>
